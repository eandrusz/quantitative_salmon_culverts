---
title: "1_prep_metabarcoding_for_quant.Rmd"
author: "Eily Allan"
date: "`r format(Sys.time(), '%B %d, %Y')`"
output: html_document
---

Script last updated: 6/2/22

# Overview

Here, we will take the combined ASV table and it with taxonomy -  we will also collapse to different taxonomic ranks depending on what types of analyses we want to do. 

# Set up

## Load libraries

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(here)
library(tidyverse)
library(vegan)
library(reshape2)
```

## Read in files 
We will have three files: the ASV table (sample, hash, number of reads), the annotations (hash, taxonomy), and the metadata file (sample, associated metadata).

```{r read in files}

ASV.table <- read_csv(here("Input", "metabarcoding", "combined.MiFish.ASV.table.csv"))
annotations <- readRDS(here("Input", "metabarcoding","MiFish.all.previous.hashes.annotated.rds"))
metadata <- read.csv(here("Input", "metabarcoding", "all_mifish_metadata.csv"))

```

## Pair hashes with taxonomy 
We want to have a table that is sample and taxonomy. 

But first let's see the taxonomic resolution of our annotations. 

```{r taxonomic resolution}

# see how many were not assigned a rank
annotations %>% dplyr::count (rank) %>% arrange(desc(n))

specieslevel <- annotations %>% 
  filter(species !="")

```

So 61 of our 114 hashes annotated are to species level. Let's see how many reads that corresponds to in our full dataset. 

```{r reads and taxonomic resolution}
total.reads <- sum(ASV.table$nReads)
# we are working with 30,354,877 reads total - WOW

total.asvs <- length(unique(ASV.table$Hash))
# and those 30M reads come from 20,116 ASVs 

annotated.asvs <- intersect(annotations$representative, ASV.table$Hash)
# 91 ASVs that were found in our environmental samples were annotated to something (any taxonomic level)
# reminder that the big key of annotations here also includes some other samples (mock communities) - usually this would be weird that there are 114 annotations and so therefore some annotations are not used - but here the key is bigger than the dataset we are applying (the actual creek samples)
# another reminder that before we annotated, we removed any ASVs longer than 200 bp

annotated.asvs.not.used <- annotations %>% filter(representative %in% setdiff(annotations$representative, setdiff(annotations$representative, ASV.table$Hash)))
# just to double check what these actually are

ASV.table %>% filter(Hash %in% setdiff(annotations$representative, ASV.table$Hash))
# and triple checking that none of the samples have these ASVs

annotated.reads <- ASV.table %>% 
  filter(Hash %in% annotations$representative) 

total.annotated.reads <- sum(annotated.reads$nReads)
# great - 22,967,816 reads are annotated - these come from the 91 annotated ASVs in the dataset 

check <- setdiff(annotated.asvs, unique(annotated.reads$Hash))
# we knew this but good to double check 

```

```{r}

# this taxonomy file is the "good" annotations to species and genus level so let's get rid of the other junk for right now 
MiFish.simple.annotations <- MiFish.annotations %>% 
  select(representative, class, taxon, species) %>% 
  rename(Hash = representative)

MiFish.ASV.taxon <- MiFish.ASV.table %>% 
  left_join(MiFish.simple.annotations, by = "Hash") %>% 
  select(-Locus)

# we can also do this at the species level 
MiFish.by.species <- MiFish.ASV.taxon %>% 
  select(-Hash) %>% # we don't need the hash identifier anymore
  filter(species != "") %>% 
  group_by(Sample_name, class, species) %>% # for each sample that has multiple asvs that assign to the same taxa...
  summarise(tot = sum(nReads))

```