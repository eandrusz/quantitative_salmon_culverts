---
title: "Statistical Supplement -- Salmon Culverts"
author: "NGN Team"
date: "2022-10-11"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)

library(tidyverse)
library(here)
library(rstan)
library(loo)
rstan_options(auto_write = TRUE)
options(mc.cores = parallel::detectCores())

```

Our analysis depends upon a set of quantitative models, each linking our observations of metabarcoding reads or qPCR cycle-threshold values to an underlying concentration of target-species DNA in water samples. 

In summary, we (1) use a mock community with a known composition to calibrate our environmental metabarcoding data as described in Shelton et al. 2022. The result is a set of estimated proportions of DNA from each species in each sample. We then (2) relate qPCR cycle-threshold values for a reference species (here, *O. clarkii*) from the same set of samples to a standard curve to yield quantitative estimates of the concentration of our reference species in each sample. We (3) use these absolute estimates of DNA concentration to expand the metabarcoding-derived proportion data into a complete set of quantitative estimates of DNA concentrations for each species in each sample. Finally, we (4) construct a time-series model for these species-specific concentrations, sharing information across creeks and time-points. This allows us to interpolate unobserved data points and more important, to compare our observations to the (counterfactual) expecations for species' DNA concentrations in the absence of a construction project. We detail the statistical details of these steps below.

## Calibration with a Mock Community

See Shelton et al. 2022; McLaren et al; Silverman et al


## qPCR Calibration

See Shelton et al. 2019; McCall et al. 2014 (https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4133581/)

## Expanding Proportions into Absolute Abundances

See Pont et al. 2022; McClaren 2022 pre-print

## Time-Series Model

At a given station in a given greek, there is some distribution of DNA concentration for a species. For simplicity, we focus on a single species and a single station (downstream or upstream) for the moment.

The (log) DNA concentration in creek $i$ at time $t$ is distributed as $Y_{i,t} \sim \mathcal{N}(\mu_{i,t},\,\sigma^{2})$. We may choose to let $\sigma$ vary across creeks, time points, or with a covariate such as creek flow.

We are interested in how the DNA concentration changes over time, so we assert that the expected value of DNA in a creek at time $t$, $\mu_{i,t}$, depends upon its value in the previous time step $t-1$, in some way. Further, we can let $\mu_{i,t}$ in, say, our focal Padden creek, depend upon the observations in other creeks (i.e., where creek $i \neq \text{Padden}$) if we think that similar environmental and demographic forces are affecting all creeks in similar ways. We can use these inferences to model data we cannot observe directly -- namely, a contrafactual scenario in which a human intervention did not occur -- to estimate the effect of that intervention.

To share information across creeks, we could assert that the relationship between $\mu_{i,t}$ and $\mu_{i,t-1}$ has a consistent slope for all creeks within a timepoint -- that is, a species tends to be increasing (or decreasing) across all creeks within the same time interval. Our model would then look like this:

$$
Y_{i,t} \sim \mathcal{N}(\mu_{i,t},\,\sigma^{2})
\\
\mu_{i,t} = \mu_{i,t-1} + \beta_{t-1}\mu_{i,t-1} + \eta_{i,t}
$$

where the slope term, $\beta$, is shared across creeks for a given time point, and where $\eta$ is the additional change in concentration not otherwise explained by the autocorrelation.

This model shares enough information across time points (within a creek) and across creeks (within a time point) that we can use it to infer DNA concentrations that we do not actually observe -- we treat the temporal/spatial points to be inferred as missing data, parameters to be estimated by the larger model.

Moreover, we can use both upstream and downstream data from the same creeks and timepoints by adding an additional subscript. This gives us more information overall, and also gives us a way of measuring the effect of position (upstream vs downstream) in the creeks.

If we let $d$ be a subscript indicating station ($d = 1 \text{ if downstream, } d = 2 \text{ if upstream}$), and nothing else changes:

$$
Y_{i,t,d} \sim \mathcal{N}(\mu_{i,t,d},\,\sigma^{2})
\\
\mu_{i,t,d} = \mu_{i,t-1,d} + \beta_{t-1}\mu_{i,t-1,d} + \eta_{i,t,d}
$$ 

The slope term, $\beta$ is now shared across all sites and stations within a time point. The $\eta$ terms are all drawn from a common normal distribution of mean 0 and standard deviation of $\sigma_{eta}$, and the standard deviation for observations is a single shared term across all samples, representing variation among triplicate biological observations at a creek/time/station.

We could simulate new data, given the parameters in hand, for upstream and downstream of a culvert in any given creek; the difference would be the effect of the culvert. But the $eta$ term gives us a way of estimating the effect of the culverts themselves, after subtracting out the effects of autocorrelation and seasonal variation: we can simply take the difference between upstream and downstream values of $eta$ for a given creek/time, and that should give us the answer.

Finally, we can jointly model multiple species, indexed by `j`, in the same set of samples, for a single overall model of the change in eDNA concentration among species, creeks, timepoints, and stations. We complete the model by specifying the prior distributions from which each  parameter is drawn.

$$
Y_{i,t,d,j} \sim \mathcal{N}(\mu_{i,t,d,j},\,\sigma^{2})
\\
\mu_{i,t,d,j} = \mu_{i,t-1,d,j} + \beta_{t-1,j}\mu_{i,t-1,d,j} + \eta_{i,t,d,j}
\\
\beta \sim \mathcal{N}(0, 5)
\\
\sigma \sim gamma(1,1)
\\
\eta \sim \mathcal{N}(0, \sigma_{eta})
\\
\sigma_{eta} \sim gamma(1,1)
$$ 



